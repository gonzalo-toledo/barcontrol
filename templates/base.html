<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Sistema de Gesti√≥n{% endblock %}</title>
  <style>
    :root { --bg:#f8f9fa; --fg:#212529; --muted:#6c757d; --card:#fff; --b:#dee2e6; --primary:#0d6efd; --success:#198754; }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--fg);line-height:1.5}
    header{background:var(--card);border-bottom:1px solid var(--b);padding:1rem 0}
    .wrap{max-width:1200px;margin:0 auto;padding:0 20px}
    nav a{color:var(--muted);text-decoration:none;margin-right:1rem}
    nav a:hover{color:var(--fg)}
    .btn{display:inline-block;padding:.5rem 1rem;border-radius:6px;text-decoration:none;font-weight:600;border:1px solid var(--b);background:#fff;color:var(--fg);transition:background .2s}
    .btn:hover{background:#f2f2f2}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .card{background:var(--card);border:1px solid var(--b);border-radius:8px}
    .card.pad{padding:1.25rem}
    .grid{display:grid;gap:1rem}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.75rem;border-bottom:1px solid var(--b);vertical-align:top}
    th{font-size:.8rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left}
    .right{text-align:right}
    .center{text-align:center}
    .section{margin:1.25rem 0}
    form .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
    input,select{width:100%;padding:.6rem;border:1px solid var(--b);border-radius:6px;background:#fff}
    .pagination{display:flex;gap:.5rem;justify-content:center;margin:1rem 0}
    .pill{display:inline-block;background:#eef;border:1px solid #ccd;padding:.1rem .5rem;border-radius:999px;font-size:.75rem}
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
    <div><strong>Sistema de Gesti√≥n</strong></div>

    {% if request.user.is_authenticated %}
      <nav style="display:flex;align-items:center;gap:1rem;">
        <a href="{% url 'upload_invoice' %}">Cargar factura</a>
        <a href="{% url 'list_invoices' %}">Listado de facturas</a>
        <a href="{% url 'productos_list' %}">Productos</a>
        <a href="{% url 'proveedores_list' %}">Proveedores</a>

        <span class="muted" style="margin-left:1rem;">
          üë§ {{ request.user.username }}
        </span>
        <a href="{% url 'logout' %}" class="btn" style="margin-left:.5rem;">Cerrar sesi√≥n</a>
      </nav>
    {% endif %}
  </div>

    <!-- Mensajes de alerta -->
  {% if messages %}
    <div style="margin: 1rem 0">
      {% for message in messages %}
        <div style="padding: 10px; border-radius: 6px;
                    background-color: {% if message.tags == 'success' %}#e6ffed{% elif message.tags == 'error' %}#ffe5e5{% else %}#f1f1f1{% endif %};
                    border: 1px solid #ccc;">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

</header>

<main class="wrap" style="margin:2rem auto">
  {% block content %}{% endblock %}
</main>

<!-- üí¨ Chat flotante con IA -->
<div id="chat-bubble" 
     style="position:fixed;bottom:25px;right:25px;width:60px;height:60px;
            background:#0d6efd;border-radius:50%;box-shadow:0 3px 8px rgba(0,0,0,0.3);
            display:flex;justify-content:center;align-items:center;
            color:#fff;font-size:28px;cursor:pointer;z-index:9999;">
  üí¨
</div>

<div id="chat-window" 
     style="position:fixed;bottom:100px;right:25px;width:340px;height:420px;
            background:#fff;border:1px solid #dee2e6;border-radius:10px;
            box-shadow:0 4px 12px rgba(0,0,0,0.2);
            flex-direction:column;overflow:hidden;z-index:9999;
            display:none;">
  
  <div style="background:#0d6efd;color:#fff;padding:12px;font-weight:600;
              display:flex;justify-content:space-between;align-items:center;">
    <span>Asistente IA</span>
    <button id="chat-close" 
            style="background:none;border:none;color:white;font-size:18px;cursor:pointer;">‚úñ</button>
  </div>

  <div id="chat-messages" 
       style="flex:1;padding:12px;overflow-y:auto;font-size:14px;line-height:1.4;">
    <div style="color:#6c757d;">ü§ñ Hola, soy tu asistente. ¬øEn qu√© puedo ayudarte?</div>
  </div>

  <form id="chat-form" 
        style="display:flex;border-top:1px solid #dee2e6;">
    <input id="chat-input" 
           type="text" 
           placeholder="Escrib√≠ tu mensaje..." 
           style="flex:1;padding:10px;border:none;outline:none;font-size:14px;">
    <button type="submit" 
            style="background:#0d6efd;color:#fff;border:none;padding:10px 15px;
                   cursor:pointer;font-weight:600;">‚û§</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const bubble = document.getElementById("chat-bubble");
  const windowEl = document.getElementById("chat-window");
  const closeBtn = document.getElementById("chat-close");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");
  const messages = document.getElementById("chat-messages");

  // Mostrar / ocultar chat al presionar la burbuja
  bubble.addEventListener("click", () => {
    windowEl.style.display = (windowEl.style.display === "none" || !windowEl.style.display) 
      ? "flex" 
      : "none";
  });

  closeBtn.addEventListener("click", () => windowEl.style.display = "none");

  // Precarga del historial
  try {
    const res = await fetch("/chat/api/");
    const data = await res.json();
    if (data.messages) {
      data.messages.forEach(m => {
        const who = m.role === "user" ? "üßç‚Äç‚ôÇÔ∏è T√∫" : "ü§ñ IA";
        appendMessage(who, m.message, m.role);
      });
    }
  } catch (e) { console.warn("No se pudo cargar historial del chat:", e); }

  // Env√≠o de mensaje
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    appendMessage("üßç‚Äç‚ôÇÔ∏è T√∫", text, "user");
    input.value = "";
    appendMessage("ü§ñ IA", "Escribiendo...", "typing");

    try {
      const res = await fetch("/chat/api/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: text})
      });

      const data = await res.json();
      replaceTypingWithReply(data.reply || "‚ö†Ô∏è Error en la respuesta.");
    } catch {
      replaceTypingWithReply("‚ö†Ô∏è Error de conexi√≥n con el asistente.");
    }
  });

  function appendMessage(sender, text, cls = "") {
    const div = document.createElement("div");
    div.className = cls;
    div.style.marginBottom = "8px";
    div.innerHTML = `<b>${sender}:</b> ${text}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function replaceTypingWithReply(text) {
    const typing = messages.querySelector(".typing");
    if (typing) typing.remove();
    appendMessage("ü§ñ IA", text, "bot");
  }
});
</script>


</body>
</html>
